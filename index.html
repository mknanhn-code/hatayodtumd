<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // --- 1. SUPABASE BAĞLANTISI ---
    // Buraya Test sayfasında çalışan bilgileri aynen yapıştır.
    // Tırnak işaretlerini silmemeye dikkat et!
    
    const supabaseUrl = 'https://hftrmiiacxgtkarsvupn.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhmdHJtaWlhY3hndGthcnN2dXBuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3ODUzNzIsImV4cCI6MjA4MDM2MTM3Mn0.BgCk5xuZx6AZuxzfBHcQqg8j8BtxU9FbupDgoFecG_k'

    // Bağlantıyı başlat
    let supabase;
    try {
        supabase = supabase.createClient(supabaseUrl, supabaseKey);
        console.log("Supabase başlatıldı.");
    } catch (err) {
        alert("Kod Hatası: URL veya Key kısmında tırnak işareti hatası var!");
        console.error(err);
    }

    // --- 2. YARDIMCI FONKSİYONLAR ---
    function switchForm(type) {
        document.getElementById('systemMessage').style.display = 'none';
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const bg = document.getElementById('btn-bg');
        const buttons = document.querySelectorAll('.toggle-btn');

        if (type === 'login') {
            loginForm.classList.add('active-form'); registerForm.classList.remove('active-form');
            bg.style.left = '5px'; buttons[0].classList.add('active'); buttons[1].classList.remove('active');
        } else {
            loginForm.classList.remove('active-form'); registerForm.classList.add('active-form');
            bg.style.left = '50%'; buttons[0].classList.remove('active'); buttons[1].classList.add('active');
        }
    }

    function showMessage(msg, type) {
        const msgBox = document.getElementById('systemMessage');
        msgBox.innerText = msg;
        msgBox.className = 'message-box ' + type;
        msgBox.style.display = 'block';
    }

    // --- 3. KAYIT OLMA (DEBUG MODU) ---
    document.getElementById('registerForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log("Kayıt butonuna basıldı."); // Konsol kontrolü
        
        const btn = this.querySelector('button');
        const originalText = btn.innerText;
        btn.innerText = 'İşleniyor...';
        btn.disabled = true;

        const email = document.getElementById('regEmail').value;
        const password = document.getElementById('regPassword').value;
        const fullName = document.getElementById('regName').value;

        try {
            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password,
                options: { data: { full_name: fullName } }
            });

            if (error) {
                console.error("Supabase Hatası:", error); // Detaylı hata konsolda
                showMessage("HATA: " + error.message, "msg-error");
                // Eğer "Email not confirmed" hatasıysa, panelden kapatmayı unutma.
            } else {
                console.log("Başarılı:", data);
                showMessage("Kayıt Başarılı! Giriş yapabilirsiniz.", "msg-success");
                setTimeout(() => { switchForm('login'); }, 2000);
            }
        } catch (err) {
            alert("Beklenmedik bir hata oluştu: " + err.message);
            console.error(err);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    });

    // --- 4. GİRİŞ YAPMA (DEBUG MODU) ---
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log("Giriş butonuna basıldı.");

        const btn = this.querySelector('button');
        const originalText = btn.innerText;
        btn.innerText = 'Kontrol ediliyor...';
        btn.disabled = true;
        
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        try {
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });

            if (error) {
                console.error("Giriş Hatası:", error);
                showMessage("Giriş Başarısız: " + error.message, "msg-error");
                btn.innerText = originalText;
                btn.disabled = false;
            } else {
                console.log("Giriş Başarılı:", data);
                showMessage("Giriş Başarılı! Yönlendiriliyorsunuz...", "msg-success");
                
                const userName = data.user.user_metadata.full_name || "Üye";
                localStorage.setItem("kullaniciAdi", userName);
                
                setTimeout(() => {
                    window.location.href = "dashboard.html"; 
                }, 1000);
            }
        } catch (err) {
            alert("Sistem Hatası: " + err.message);
            btn.innerText = originalText;
            btn.disabled = false;
        }
    });
</script>
